<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{% block title %}SaludGo{% endblock %}</title>

  <!-- Fuentes y Bootstrap -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">


  <!-- Estilos propios -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  {% block head_extra %}{% endblock %}
</head>
<body{% if user %} class="logged-in"{% endif %}>

<!-- =====================================================
     NAVBAR GUBERNAMENTAL SALUDGO
===================================================== -->
<nav class="navbar navbar-expand-lg fixed-top navbar-gov">
  <div class="container align-items-center justify-content-between">

    <!-- Logos institucionales -->
    <div class="d-flex align-items-center gap-3">
      <a href="https://www.cundinamarca.gov.co" target="_blank"
         class="d-none d-md-flex align-items-center gov-link"
         title="Gobernaci√≥n de Cundinamarca">
        <img src="https://res.cloudinary.com/dbussh6oa/image/upload/v1762402545/logo-gobernacion_wuzs2f.jpg"
             alt="Gobernaci√≥n de Cundinamarca" class="gov-logo">
      </a>

      <a href="{{ url_for('index') }}" class="d-flex align-items-center gap-2">
        <img src="https://res.cloudinary.com/academia-geek-1/image/upload/v1759081635/logo_crfjxt.jpg"
             alt="SaludGo" class="saludgo-logo">
      </a>

      <a href="https://www.boyaca.gov.co" target="_blank"
         class="d-none d-md-flex align-items-center gov-link"
         title="Gobernaci√≥n de Boyac√°">
        <img src="https://res.cloudinary.com/dbussh6oa/image/upload/v1762402491/logo_gobernacion_de_cundinamarca_pod8b3.png"
             alt="Gobernaci√≥n de Boyac√°" class="gov-logo">
      </a>
    </div>

    <!-- Bot√≥n mobile -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarGov">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- Contenido colapsable -->
    <div id="navbarGov" class="collapse navbar-collapse">

      <ul class="navbar-nav mx-auto align-items-center">
        {% if not user %}
          <!-- Men√∫ p√∫blico -->
          <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}#servicios">Servicios</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}#quienes">Qui√©nes somos</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}#elegirnos">¬øPor qu√© elegirnos?</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}#publicaciones">Publicaciones</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('participa') }}">Participa</a></li>
          <li class="nav-item"><a class="nav-link" href="{{ url_for('index') }}#contacto">Cont√°ctenos</a></li>
        {% else %}
          <!-- Men√∫ para usuario logueado -->
          {% if user['role'] == 'admin' %}
            <li class="nav-item"><a class="nav-link" href="{{ url_for('admin') }}">Panel</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_citas') }}">Citas</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('admin_medicamentos') }}">Medicamentos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('reportes') }}">Reportes</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('perfil') }}">Perfil</a></li>
          {% else %}
            <li class="nav-item"><a class="nav-link" href="{{ url_for('perfil') }}">Perfil</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('mis_citas') }}">Mis citas</a></li>
          {% endif %}
        {% endif %}
      </ul>

      <!-- Bot√≥n derecho -->
      <div class="d-flex align-items-center">
        {% if not user %}
          <button class="btn btn-pill"
                  data-bs-toggle="modal"
                  data-bs-target="#authModal">
            Ingresar / Registrarme
          </button>
        {% else %}
          <span class="navbar-text small text-muted me-2">
            üë§ <strong>{{ user['username'] }}</strong>
          </span>
          <a class="btn btn-pill btn-logout" href="{{ url_for('logout') }}">Salir</a>
        {% endif %}
      </div>
    </div>
  </div>
</nav>


<div style="padding-top: 90px"></div>

<!-- =====================================================
     FLASH MESSAGES
===================================================== -->
<div class="container mt-2">
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for cat, msg in messages %}
      <div class="alert alert-{{ cat }} alert-dismissible fade show" role="alert">
        {{ msg }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
      {% endfor %}
    {% endif %}
  {% endwith %}
</div>

<!-- =====================================================
     CONTENIDO PRINCIPAL
===================================================== -->
{% block content %}{% endblock %}

<footer class="py-3 text-center">
  <small>¬© 2025 SaludGo. Plataforma de salud p√∫blica aliada con Gobernaciones de Cundinamarca y Boyac√°</small>
</footer>

<!-- ================= MODAL AUTH ================= -->
<div class="modal fade" id="authModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content auth-modal">
      <div class="row g-0 align-items-stretch">

        <!-- Lado izquierdo: bloque institucional -->
        <div class="col-md-5 d-none d-md-flex auth-hero">
          <div class="auth-hero-inner">
            <div>
              <span class="auth-hero-badge">
                SaludGo ¬∑ Plataforma de salud p√∫blica
              </span>
              <h3 class="auth-hero-title">Acceso seguro a tus servicios de salud</h3>
              <p class="auth-hero-text">
                Consulta citas, campa√±as y reportes desde un entorno pensado para entidades
                territoriales y ciudadan√≠a.
              </p>
            </div>

            <ul class="auth-hero-list">
              <li>Agendamiento y seguimiento en l√≠nea.</li>
              <li>Orientaci√≥n para equipos de salud y comunidad.</li>
              <li>Enfoque en salud p√∫blica y territorio.</li>
            </ul>
          </div>
        </div>

        <!-- Lado derecho: tabs + formularios -->
        <div class="col-md-7">
          <div class="p-4 p-md-4">

            <!-- Encabezado derecho -->
            <div class="auth-header mb-3">
              <h5 class="auth-title mb-1">Acceso a SaludGo</h5>
              <p class="auth-subtitle mb-0">
                Ingresa con tu usuario o crea una cuenta para gestionar servicios de salud.
              </p>
            </div>

            <!-- Tabs: Ingresar / Registrarme / Recuperar clave (oculta) -->
            <ul class="nav nav-pills auth-tabs mb-3" id="authTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="ingresar-tab"
                        data-bs-toggle="tab" data-bs-target="#ingresar"
                        type="button" role="tab" aria-controls="ingresar" aria-selected="true">
                  Ingresar
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="registrarme-tab"
                        data-bs-toggle="tab" data-bs-target="#registrarme"
                        type="button" role="tab" aria-controls="registrarme" aria-selected="false">
                  Registrarme
                </button>
              </li>
              <!-- pesta√±a de recuperar clave OCULTA, la activa el bot√≥n "¬øOlvidaste tu contrase√±a?" -->
              <li class="nav-item d-none" role="presentation">
                <button class="nav-link" id="forgot-tab"
                        data-bs-toggle="tab" data-bs-target="#forgot"
                        type="button" role="tab" aria-controls="forgot" aria-selected="false">
                  Recuperar clave
                </button>
              </li>
            </ul>

            <!-- Contenido tabs -->
            <div class="tab-content">

              <!-- TAB: Ingresar -->
              <div class="tab-pane fade show active" id="ingresar" role="tabpanel" aria-labelledby="ingresar-tab">
                <form method="post" action="{{ url_for('auth_login') }}" class="auth-form" autocomplete="on">
                  <input type="hidden" name="next" id="authNextLogin" value="{{ request.args.get('next','') }}">

                  <div class="mb-3">
                    <label for="login_user" class="form-label">Usuario</label>
                    <input type="text"
                           class="form-control"
                           id="login_user"
                           name="username"
                           required
                           autocomplete="username">
                  </div>

                  <div class="mb-1">
                    <label for="login_pass" class="form-label mb-0">Contrase√±a</label>
                    <input type="password"
                           class="form-control"
                           id="login_pass"
                           name="password"
                           required
                           autocomplete="current-password">
                  </div>
                  <div class="mb-3 d-flex justify-content-end">
                    <button type="button"
                            class="btn btn-link btn-sm p-0 auth-forgot-link"
                            id="btnForgot">
                      ¬øOlvidaste tu contrase√±a?
                    </button>
                  </div>

                  <div class="mt-2">
                    <button class="btn btn-primary w-100 py-2 fw-semibold auth-main-btn">Entrar</button>
                  </div>
                </form>
              </div>

              <!-- TAB: Registrarme -->
              <div class="tab-pane fade" id="registrarme" role="tabpanel" aria-labelledby="registrarme-tab">
                <form method="post" action="{{ url_for('auth_register') }}" class="auth-form" autocomplete="on">
                  <input type="hidden" name="next" id="authNextSignup" value="{{ request.args.get('next','') }}">

                  <div class="mb-3">
                    <label for="reg_user" class="form-label">Usuario</label>
                    <input type="text" class="form-control" id="reg_user" name="username" required>
                  </div>
                  <div class="mb-3">
                    <label for="reg_email" class="form-label">Correo electr√≥nico</label>
                    <input type="email" class="form-control" id="reg_email" name="email" required>
                  </div>
                  <div class="mb-4">
                    <label for="reg_pass" class="form-label">Contrase√±a</label>
                    <input type="password" class="form-control" id="reg_pass" name="password" minlength="6" required>
                  </div>
                  <button class="btn btn-primary w-100 py-2 fw-semibold auth-main-btn">Crear cuenta</button>
                </form>
              </div>

              <!-- TAB: Recuperar clave (no visible en pesta√±as, pero funcional) -->
              <div class="tab-pane fade" id="forgot" role="tabpanel" aria-labelledby="forgot-tab">
                <form method="post" action="{{ url_for('auth_forgot') }}" class="auth-form">
                  <div class="mb-3">
                    <label class="form-label">Usuario o correo</label>
                    <input type="text" class="form-control" name="identifier" required>
                  </div>
                  <p class="small text-muted mb-3">
                    Si encontramos una cuenta asociada, enviaremos un enlace para cambiar tu contrase√±a.
                    Tendr√°s <strong>5 minutos</strong> para usarlo.
                  </p>
                  <button class="btn btn-primary w-100 py-2 fw-semibold auth-main-btn">Enviar enlace</button>
                </form>
              </div>

            </div> <!-- /tab-content -->

            <div class="text-center mt-4 small">
              ¬øTienes dudas?
              <a class="fw-semibold auth-contact-link"
                 href="{{ url_for('index') }}#contacto"
                 id="contactFromAuthModal">
                Cont√°ctanos
              </a>
            </div>
          </div>
        </div> <!-- /col-md-7 -->
      </div> <!-- /row -->
    </div> <!-- /modal-content -->
  </div> <!-- /modal-dialog -->
</div> <!-- /modal -->

<!-- =====================================================
     CHATBOT SALUDGO ‚Äî DOCTORCITO
===================================================== -->
{% if not user or user['role'] != 'admin' %}
<div id="sg-chatbot" style="position: fixed; bottom: 24px; right: 24px; z-index: 9999;">
  <!-- Bot√≥n flotante -->
  <button id="sg-chat-toggle" class="sg-chat-toggle" type="button" aria-label="Abrir chat SaludGo">
    <span class="sg-chat-toggle-icon">
      <img src="https://res.cloudinary.com/dbussh6oa/image/upload/v1762241375/equipo-medico_jdfajg.png"
           alt="SaludGo"
           onerror="this.style.display='none'; this.parentNode.textContent='SG';">
    </span>
  </button>

  <!-- Panel del chat -->
  <div id="sg-chat-panel" class="sg-chat-panel" style="display: none;">
    <div class="sg-chat-header">
      <div class="sg-chat-header-left">
        <div class="sg-chat-avatar">
          <img src="https://res.cloudinary.com/dbussh6oa/image/upload/v1762240874/doctor_psfwwp.png" alt="Doctorcito">
        </div>
        <div>
          <div class="sg-chat-title">Doctorcito</div>
          <div class="sg-chat-subtitle">Asistente virtual de SaludGo</div>
        </div>
      </div>
      <button type="button" class="sg-chat-close" id="sg-chat-close" aria-label="Cerrar chat">√ó</button>
    </div>

    <div id="sg-chat-messages" class="sg-chat-messages"></div>

    <form id="sg-chat-form" class="sg-chat-input-area">
      <textarea id="sg-chat-input" class="sg-chat-input" rows="1"
                placeholder="Escribe aqu√≠..." required></textarea>
      <button class="sg-chat-send" type="submit">
        <i class="fa fa-paper-plane"></i> Enviar
      </button>
    </form>
  </div>
</div>
{% endif %}
<script>
document.addEventListener("DOMContentLoaded", function () {
  // ============================
  // VARIABLES BASE
  // ============================
  const chatToggle = document.getElementById("sg-chat-toggle");
  const chatPanel = document.getElementById("sg-chat-panel");
  const chatClose = document.getElementById("sg-chat-close");
  const chatForm = document.getElementById("sg-chat-form");
  const chatInput = document.getElementById("sg-chat-input");
  const chatMsgs = document.getElementById("sg-chat-messages");

 // ============================
  // SONIDO INSTITUCIONAL
  // ============================
  const chatSound = new Audio("https://res.cloudinary.com/dbussh6oa/video/upload/v1762465289/live-chat-353605_xe8hq7.mp3");
  chatSound.volume = 0.6;

  // Activar contexto de audio con la primera interacci√≥n del usuario
  document.body.addEventListener("click", function activarSonido() {
    chatSound.play().then(() => {
      chatSound.pause();
      chatSound.currentTime = 0;
      document.body.removeEventListener("click", activarSonido);
    }).catch(() => {});
  });

  function playSound() {
    chatSound.currentTime = 0;
    chatSound.play().catch(() => {});
  }

  // ============================
  // FUNCIONES DE MENSAJE
  // ============================
  function addChatMessage(text, sender) {
    const wrap = document.createElement("div");
    wrap.className =
      "sg-chat-message " +
      (sender === "user" ? "sg-chat-message-user" : "sg-chat-message-bot");
    const bubble = document.createElement("div");
    bubble.className = "sg-chat-bubble";
    bubble.textContent = text;
    wrap.appendChild(bubble);
    chatMsgs.appendChild(wrap);
    chatMsgs.scrollTop = chatMsgs.scrollHeight;
  }

  const chatHistory = [];
  function saveMessage(sender, message) {
    chatHistory.push({ sender, message });
  }

  // ============================
  // ESTADOS Y VARIABLES
  // ============================
  let estado = "datos";
  let userData = { nombre: "", cedula: "", telefono: "" };

  const menuOpciones = `Puedo ayudarte con los siguientes temas:

1Ô∏è‚É£  Agendar una cita
2Ô∏è‚É£  Consultar medicamentos
3Ô∏è‚É£  Ver campa√±as de salud
4Ô∏è‚É£  Participar como voluntario

‚úèÔ∏è Escribe el n√∫mero de la opci√≥n que deseas.`;

  const respuestasFijas = {
    1: `ü©∫ Sobre citas en SaludGo:\n
     1Ô∏è‚É£ Si ya tienes cuenta, ingresa con tu usuario y ve al men√∫ ¬´Mis citas¬ª.\n
     2Ô∏è‚É£ Elige el tipo de cita, la fecha y la hora disponible.\n
     3Ô∏è‚É£ Si registraste tu correo, te enviaremos confirmaci√≥n por email.\n
    Si todav√≠a no tienes cuenta, crea una desde el bot√≥n ¬´Ingresar / Registrarme¬ª o comun√≠cate con la l√≠nea SaludGo 01-8000-000-000.`,
    2: `üíä En SaludGo registramos medicamentos que el equipo de salud te ha indicado.\n
            Puedes verlos en ¬´Mi perfil¬ª ‚Üí secci√≥n ¬´Medicamentos¬ª.\n
            Si falta un medicamento, la dosis cambi√≥ o tienes efectos adversos,
            debes comentarlo directamente con tu IPS o en el punto de atenci√≥n m√°s cercano.`,
           
    3: `üìÖ Sobre campa√±as y brigadas de salud:\n
            ‚Ä¢ En la p√°gina de inicio puedes ver campa√±as en las secciones de ¬´Publicaciones¬ª y ¬´Participa¬ª.\n
            ‚Ä¢ Si quieres que se programe una jornada en tu zona, puedes contarnos la situaci√≥n
            desde la secci√≥n ¬´Participa¬ª.\n
            ‚Ä¢ Tambi√©n puedes registrar tu disponibilidad para apoyar como voluntario.`,
    4: `ü§ù ¬°Gracias por querer apoyar! üíö\n
            "Para vincularte como voluntario o l√≠der comunitario:\n
            1Ô∏è‚É£ Ve a la secci√≥n ¬´Participa¬ª.\n
            2Ô∏è‚É£ Diligencia el formulario de ¬´Disponibilidad para apoyar campa√±as¬ª.\n
            3Ô∏è‚É£ El equipo de coordinaci√≥n usar√° esa base de datos para planear jornadas y contactarte.`
  };

  // ============================
  // PROCESAMIENTO PRINCIPAL
  // ============================
  async function procesarMensaje(msg) {
    const texto = msg.trim();
    if (!texto) return;

    addChatMessage(texto, "user");
    saveMessage("user", texto);
    chatInput.value = "";
    playSound();

    // ---------------- DATOS DEL USUARIO ----------------
    if (estado === "datos") {
      if (!userData.nombre) {
        userData.nombre = texto;
        addChatMessage("Gracias, " + userData.nombre + ". ¬øPodr√≠as indicarme tu n√∫mero de c√©dula?", "bot");
        saveMessage("bot", "Gracias, " + userData.nombre + ". ¬øPodr√≠as indicarme tu n√∫mero de c√©dula?");
        return;
      }

      if (!userData.cedula) {
        userData.cedula = texto;
        addChatMessage("Perfecto. Finalmente, ¬øpodr√≠as compartir tu n√∫mero de contacto?", "bot");
        saveMessage("bot", "Perfecto. Finalmente, ¬øpodr√≠as compartir tu n√∫mero de contacto?");
        return;
      }

      if (!userData.telefono) {
        userData.telefono = texto;
        addChatMessage(
          "Gracias por tus datos, " + userData.nombre + ". üë®‚Äç‚öïÔ∏è Aqu√≠ tienes las opciones disponibles:",
          "bot"
        );
        saveMessage(
          "bot",
          "Gracias por tus datos, " + userData.nombre + ". üë®‚Äç‚öïÔ∏è Aqu√≠ tienes las opciones disponibles:"
        );

        setTimeout(() => {
          addChatMessage(menuOpciones, "bot");
          saveMessage("bot", menuOpciones);
          estado = "menu";
        }, 800);
        return;
      }
    }

    // ---------------- MENU PRINCIPAL ----------------
    if (estado === "menu") {
      if (["1", "2", "3", "4"].includes(texto)) {
        const resp = respuestasFijas[texto];
        addChatMessage(resp, "bot");
        saveMessage("bot", resp);
        playSound();

        setTimeout(() => {
          addChatMessage("¬øHay algo m√°s en lo que pueda colaborarte? 1Ô∏è‚É£ S√≠  2Ô∏è‚É£ No", "bot");
          saveMessage("bot", "¬øHay algo m√°s en lo que pueda colaborarte? 1Ô∏è‚É£ S√≠  2Ô∏è‚É£ No");
          estado = "post";
        }, 1000);
      } else {
        // Si no es una opci√≥n, lo env√≠a al backend con IA
        const resp = await fetch("/chatbot", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: texto })
        });
        const data = await resp.json();
        addChatMessage(data.reply, "bot");
        saveMessage("bot", data.reply);
        playSound();

        setTimeout(() => {
          addChatMessage("¬øHay algo m√°s en lo que pueda colaborarte? 1Ô∏è‚É£ S√≠  2Ô∏è‚É£ No", "bot");
          saveMessage("bot", "¬øHay algo m√°s en lo que pueda colaborarte? 1Ô∏è‚É£ S√≠  2Ô∏è‚É£ No");
          estado = "post";
        }, 1200);
      }
      return;
    }

    // ---------------- DESPU√âS DE RESPUESTA ----------------
    if (estado === "post") {
      if (["1", "s√≠", "si", "1Ô∏è‚É£"].includes(texto.toLowerCase())) {
        addChatMessage("Perfecto, aqu√≠ tienes nuevamente las opciones:", "bot");
        saveMessage("bot", "Perfecto, aqu√≠ tienes nuevamente las opciones:");
        setTimeout(() => {
          addChatMessage(menuOpciones, "bot");
          saveMessage("bot", menuOpciones);
          estado = "menu";
        }, 800);
      } else if (["2", "no", "2Ô∏è‚É£"].includes(texto.toLowerCase())) {
        const cierre =
          "Gracias por contactarte con SaludGo. üåø\nRecuerda que juntos cuidamos la salud de nuestras comunidades en Cundinamarca y Boyac√°. üè•\nHasta pronto üíô";
        addChatMessage(cierre, "bot");
        saveMessage("bot", cierre);
        playSound();
        enviarHistorial();
        estado = "fin";
      } else {
        addChatMessage("Por favor escribe 1 para S√≠ o 2 para No.", "bot");
        saveMessage("bot", "Por favor escribe 1 para S√≠ o 2 para No.");
      }
    }
  }

 // ============================
  // GUARDAR HISTORIAL EN BASE DE DATOS
  // ============================
  async function enviarHistorial() {
    try {
      await fetch("/save_chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userData, chatHistory })
      });
    } catch (err) {
      console.error("Error guardando chat:", err);
    }
  }

  // ============================
  // EVENTOS
  // ============================
  chatForm.addEventListener("submit", e => {
    e.preventDefault();
    procesarMensaje(chatInput.value);
  });

  chatClose.addEventListener("click", () => {
    chatPanel.style.display = "none";
    enviarHistorial();
  });

 // ============================
  // SALUDO AUTOM√ÅTICO CON SONIDO
  // ============================
  setTimeout(() => {
    chatPanel.style.display = "flex";
    playSound();
    addChatMessage("üëã Bienvenido a SaludGo. Soy Doctorcito. ¬øCu√°l es tu nombre completo?", "bot");
    saveMessage("bot", "üëã Bienvenido a SaludGo. Soy Doctorcito. ¬øCu√°l es tu nombre completo?");
  }, 1500);

  // ============================
  // PIE DE P√ÅGINA INSTITUCIONAL
  // ============================
  const footer = document.createElement("div");
  footer.className = "sg-chat-footer";
  footer.innerHTML = `
    <div class="sg-footer-content">
      <img src="https://res.cloudinary.com/dbussh6oa/image/upload/v1762402545/logo-gobernacion_wuzs2f.jpg" 
           alt="Gobernaci√≥n de Cundinamarca" class="gov-logo">
      <img src="https://res.cloudinary.com/dbussh6oa/image/upload/v1762402491/logo_gobernacion_de_cundinamarca_pod8b3.png" 
           alt="Gobernaci√≥n de Boyac√°" class="gov-logo">
    </div>
    <p class="sg-footer-text">
      Plataforma de salud p√∫blica aliada con Gobernaciones de Cundinamarca y Boyac√°.
    </p>
  `;
  chatPanel.appendChild(footer);
});
</script>





<!-- =====================================================
     SCRIPTS GLOBALES
===================================================== -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Scroll suave SOLO para enlaces tipo #ancla (por si los usas en el contenido)
    document.querySelectorAll('a.nav-link, .navbar-brand').forEach(a => {
      a.addEventListener('click', function (e) {
        const href = a.getAttribute('href');
        if (href && href.startsWith('#')) {
          e.preventDefault();
          const el = document.querySelector(href);
          if (el) el.scrollIntoView({ behavior: 'smooth' });
        }
      });
    });

    // Bot√≥n "¬øOlvidaste tu contrase√±a?" -> activa pesta√±a Recuperar clave (oculta)
    const forgotBtn = document.getElementById('btnForgot');
    if (forgotBtn && window.bootstrap && bootstrap.Tab) {
      forgotBtn.addEventListener('click', function () {
        const forgotTabBtn = document.getElementById('forgot-tab');
        if (forgotTabBtn) {
          const tab = new bootstrap.Tab(forgotTabBtn);
          tab.show();
        }
      });
    }

    // Abrir el modal autom√°ticamente si viene ?show_login=1
    const params = new URLSearchParams(window.location.search);
    if (params.get('show_login') === '1') {
      const modalEl = document.getElementById('authModal');
      if (modalEl && window.bootstrap && bootstrap.Modal) {
        const m = new bootstrap.Modal(modalEl);
        m.show();
      }
    }

    // Link "Cont√°ctanos" dentro del modal: cerrar modal y llevar a #contacto
    const contactFromModal = document.getElementById('contactFromAuthModal');
    if (contactFromModal) {
      contactFromModal.addEventListener('click', function (e) {
        e.preventDefault();
        const href = this.getAttribute('href') || '{{ url_for("index") }}#contacto';
        const modalEl = document.getElementById('authModal');

        if (modalEl && window.bootstrap && bootstrap.Modal) {
          const instance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
          instance.hide();

          setTimeout(function () {
            if (window.location.pathname === '{{ url_for("index") }}') {
              const target = document.querySelector('#contacto');
              if (target) {
                target.scrollIntoView({ behavior: 'smooth' });
              } else {
                window.location.href = href;
              }
            } else {
              window.location.href = href;
            }
          }, 200);
        } else {
          window.location.href = href;
        }
      });
    }
  });

  // Cuando se va a mostrar el modal, elegimos la pesta√±a seg√∫n la URL (?tab=login|signup|forgot)
  document.addEventListener('show.bs.modal', function (ev) {
    const modal = ev.target;
    if (modal.id !== 'authModal') return;

    const params = new URLSearchParams(window.location.search);
    let tabParam = params.get('tab') || 'login';

    let tabId = 'ingresar-tab';
    if (tabParam === 'signup') tabId = 'registrarme-tab';
    if (tabParam === 'forgot') tabId = 'forgot-tab';

    const tabBtn = document.getElementById(tabId);
    if (tabBtn && window.bootstrap && bootstrap.Tab) {
      const tab = new bootstrap.Tab(tabBtn);
      tab.show();
    }
  });

  // Mantener el campo "next" cuando abres el modal desde un bot√≥n con data-next
  document.addEventListener('shown.bs.modal', function (ev) {
    const btn = ev.relatedTarget;
    if (!btn) return;
    const next = btn.getAttribute('data-next') || '';
    const lg = document.getElementById('authNextLogin');
    const sg = document.getElementById('authNextSignup');
    if (lg) lg.value = next;
    if (sg) sg.value = next;
  });

      
</script>
<script>
  window.addEventListener("scroll", function() {
    const nav = document.querySelector(".navbar-gov");
    if (window.scrollY > 20) {
      nav.classList.add("scrolled");
    } else {
      nav.classList.remove("scrolled");
    }
  });
</script>
{% block scripts_extra %}{% endblock %}
</body>
</html>
